<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8"/>
<title>Ricochet Robots</title>
<script src="https://d3js.org/d3.v5.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<link rel="stylesheet" href="style.css">
<script src="logic.js"></script>
</head>
<body>
<div id="head">
<div id="alltime">&nbsp;</div>
<div id="time">&nbsp;</div>
<h1>Ricochet Robots</h1>
<div id="points">
  <span id="turn">&nbsp;</span>
  <div>Runde: <span id="round">1</span><br>Ziele: <span id="targets">0</span><br>Züge: <span id="fullpoints">0</span></div>
</div>
<div id="allpoints">&nbsp;</div>
</div>
<div id="wrap">
<div id="map"></div>
<div id="solutionwrapper">
</div>
</div>
<div id="players"></div>
<!--<div id="anleitung">Tastatursteuerung: 1-4 Roboterauswahl, Pfeiltasten Bewegung, Backspace Schritt zurück, Escape auf Anfang. Klicken geht auch.</div>-->
<script>
// TODO: purge d3, should not be difficult without
// TODO: purge font awesome?

// TODO make countdown seconds after solution found a variable?
// TODO make use of fifth robot a variable?
// TODO: give up finding a solution, or a shorter solution - if everyone gives up, fine
// TODO: give ghosts a non-transparent :after for the arrow pointer depending from which direction the arrow comes
// TODO: anleitung (ricochet robots rules, bedienung)
// TODO: display other players in game somewhere convenient (plain text list below, centered)
var path = "http://wollmilchmedien.de/ricochetrobots/"
var scale = 20;
var colors = ["red", "blue", "yellow", "green", "black"];
var directions = ["up", "left", "down", "right"];

var turn; // gets set every turn
var map; // gets set on map creation
var game; // gets set on game start

var ajaxtime = Date.now(); // time the last ajax request was sent
var ajaxspeed = 5000;//200; // milliseconds between ajax requests

var data = { // ajax data
  game: {robots: [], pieces: [], seed: 0, round: 0, solved: null, solution: null},
  me: {name: "Gast", targets: 0, points: 0, round: 0, solved: null, solution: null},
}

var ismine = false; // whether or not the found solution is by the player

var players = []; // received data from other players

ajax("init", {}, init, solo);
function init(response) { console.log(response);
  for (var i=0; i<response.error.length; i++) {console.log(response.error[i]);}
  ajaxtime = Date.now();
  window.requestAnimationFrame(loop); 
  if (null==response.gamedata || null==response.gamedata.json) {showLobby(); return;}
  restoreGame(response);
  display("Laufendem Spiel beigetreten!");
}

function restoreGame(response) {
  var solved = response.gamedata.json.solved; // restoreGame will reset this, so I need to collect it before
  var gamesolution = response.gamedata.json.solution;
  enterGame(response);
  data.game.solved = solved;
  data.game.solution = gamesolution;
  if (null != solved) {
    game.timeleft = 60-Math.round((Date.now()-solved)/1000);
    if (game.timeleft>60) game.timeleft=60; // everyone left the game before the timer was up
    countdown(game.timeleft);
    document.querySelector("#points #turn").innerHTML = data.game.solution.length;
  }
}

function enterGame(response) {
  data.game = response.gamedata.json;
  map = {nested: [], tiles: [], targets: [], 
         robots: response.gamedata.json.robots, 
	 pieces: response.gamedata.json.pieces, 
	 seed: response.gamedata.json.seed};
  game = {timer: null, timeleft: null, running: false, points: 0, targetsWon: 0}
  turn = {solutions: [], solution: [], fastest: null, target: data.game.round-1, robot: null, points: 0};
  var me = null;
  var worst = 0;
  for (var i=0; i<response.playerdata.length; i++) {
    var player = response.playerdata[i];
    if (player.hasOwnProperty("me") && player.me) {
      if (null!=player.solution && null!=data.game.solution 
	  && null!=data.game.solved && null!=player.solved 
	  && data.game.solved==player.solved) 
	isMine=true; // last solution found was own
      me = player;
    } else {
      if (null!=response.playerdata[i]["json"].points && response.playerdata[i]["json"].points > worst) 
        worst = response.playerdata[i]["json"].points;
      players.push(player["json"]);
    }
  }
  if (null != me && null != me.json && null != me.json.points && null != game.points) {
    if (data.me.name == "Gast") data.me.name = (me.json.name == "Gast") ? me.name : me.json.name;
    data.me.targets = me.json.targets;
    game.targetsWon = me.json.targets;
    if (me.json.round==data.game.round-1) { // last seen last round
      game.points = me.json.points;
      data.me.points = game.points;
    }
    if (me.json.round==data.game.round) { // last seen this round
      game.points = me.json.points;
      data.me.points = game.points;
      data.me.solution = me.json.solution;
      if (me.json.solution!=null) turn.points = me.json.solution.length;
    }
    else { // too long ago, new points set
      game.points = worst+(10*(data.game.round-me.json.round));
      data.me.points = game.points;
    }
  } else if (null != game.points && null != data.game.round) {
    game.points = worst+(10*data.game.round);
    data.me.points = game.points;
  } else {data.me.points = 0;}
  createMap();
  d3.select(window).on("keydown", handleKey);
  activateNextTarget();
  game.running = true;
}

function play(response) { console.log(response);
  for (var i=0; i<response.error.length; i++) {console.log(response.error[i]);}
  var ta_players = []; // transactional TODO why?!?
  var names = [];
  var me = null;
  for (var i=0; i<response.playerdata.length; i++) {
    var player = response.playerdata[i];
    if (!player.hasOwnProperty("json") || null == player["json"] || "" == player["json"]) continue;
    if (player.hasOwnProperty("me") && player.me) data.me = player["json"];
    else {
      ta_players.push(player["json"]);
      if ((Date.now()-(new Date(player["time"]))<(5*ajaxspeed) && 
         (null==response.gamedata || null==response.gamedata.json || data.game.round==player["json"].round)))
         {names.push(player["json"].name);}
    }
  }
  players = ta_players;
  if (0==data.game.seed) { // currently not in a game
    if (null!=response.gamedata && null!= response.gamedata.json && 0!=response.gamedata.seed) { // ... but there is a game
      restoreGame(response);
      display("Ein Spiel wurde gestartet!");
    }
  }
  else { // currently in a game
    if (null==response.gamedata || null== response.gamedata.json || 0==response.gamedata.seed) {endGame(); return;} // ... but game has ended
    if (data.me.round==response.gamedata.json.round) { // we are in the same turn as the rest of the game
      if (data.game.solved != response.gamedata.json.solved) // TODO fuck, I'm only ever going to get my own game data back!
      for (var i=0; i<players.length; i++) {
      
      }
    }
    else if (data.me.round==response.gamedata.json.round-1) { // we are one turn off
      clearInterval(game.timer); // make sure the clock is no longer ticking
      endTurn(); 
    }
    else { // off by more than one turn, or magically ahead
      data.game = response.gamedata.json;
      restoreGame(response); // best to redraw completely
      display("Spiel neu geladen");
    }


    // TODO identify best solution and set player that did it - already done, just needs to check if it's mine
    // TODO if time is up set countdown to 1 or something
    // TODO set ismine according to me flag
    // TODO has someone found a better solution? a first solution? do we need to start the timer? has the game ended?
    // TODO Do we need to update the timer?
  }  
}

</script>
</body>
</html>
